name: Clean Up Workflows

on:
  workflow_dispatch:
    inputs:
      days_old:
        description: '清理多少天前的工作流记录 (默认: 30)'
        required: false
        default: '30'
      workflow_ids:
        description: '要清理的工作流ID，用逗号分隔，留空表示清理所有工作流'
        required: false
  schedule:
    # 每月1日的UTC 00:00 运行
    - cron: '0 0 1 * *'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install GitHub CLI
        run: |
          wget https://github.com/cli/cli/releases/download/v2.37.0/gh_2.37.0_linux_amd64.deb
          sudo dpkg -i gh_2.37.0_linux_amd64.deb

      - name: Clean up workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_OLD: ${{ github.event.inputs.days_old || '30' }}
          WORKFLOW_IDS: ${{ github.event.inputs.workflow_ids }}
        run: |
          # 授权 GitHub CLI
          echo "$GITHUB_TOKEN" | gh auth login --with-token

          # 确定要清理的工作流
          if [ -z "$WORKFLOW_IDS" ]; then
            echo "正在清理所有工作流..."
            WORKFLOWS=$(gh api repos/${{ github.repository }}/actions/workflows | jq -r '.workflows[].id')
          else
            echo "正在清理指定的工作流: $WORKFLOW_IDS"
            WORKFLOWS=$(echo $WORKFLOW_IDS | tr ',' ' ')
          fi

          # 获取当前时间戳并计算截止日期
          CURRENT_TIMESTAMP=$(date +%s)
          CUTOFF_TIMESTAMP=$((CURRENT_TIMESTAMP - DAYS_OLD * 86400))
          CUTOFF_DATE=$(date -d @$CUTOFF_TIMESTAMP +"%Y-%m-%dT%H:%M:%SZ")
          echo "清理 $DAYS_OLD 天前 ($CUTOFF_DATE) 的工作流记录"

          # 遍历每个工作流并清理旧的运行记录
          for WORKFLOW_ID in $WORKFLOWS; do
            echo "处理工作流ID: $WORKFLOW_ID"
            
            # 获取该工作流的所有运行记录
            RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs | jq -r '.workflow_runs[] | select(.created_at < "'$CUTOFF_DATE'") | .id')
            
            # 删除每个旧的运行记录
            for RUN_ID in $RUNS; do
              echo "删除运行记录ID: $RUN_ID"
              gh api repos/${{ github.repository }}/actions/runs/$RUN_ID -X DELETE || echo "删除失败，可能已被删除"
            done
          done

          echo "清理完成!"